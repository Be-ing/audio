use std::fs;
use std::io;
use std::io::Write as _;
use std::path::PathBuf;
use std::process;

fn main() -> io::Result<()> {
    let tokens = windows_macros::generate!(
        Windows::Win32::Media::Audio::CoreAudio::*,
        Windows::Win32::Media::Multimedia::{
            WAVEFORMATEX,
            WAVEFORMATEXTENSIBLE,
            WAVE_FORMAT_PCM,
            WAVE_FORMAT_IEEE_FLOAT,
            KSDATAFORMAT_SUBTYPE_IEEE_FLOAT,
        },
        Windows::Win32::Storage::StructuredStorage::PROPVARIANT,
        Windows::Win32::System::Com::{CoTaskMemAlloc, CoTaskMemFree, CLSIDFromProgID, CoInitializeEx, CoCreateInstance, CLSCTX},
        Windows::Win32::UI::WindowsAndMessaging::GetForegroundWindow,
        Windows::Win32::System::Threading::{
            CreateEventA,
            ResetEvent,
            SetEvent,
            WAIT_RETURN_CAUSE,
            WaitForSingleObject,
            WaitForMultipleObjects,
        },
        Windows::Win32::Foundation::{
            HANDLE,
            INVALID_HANDLE_VALUE,
            S_FALSE,
            CloseHandle,
            BOOL,
        },
        Windows::Win32::System::WindowsProgramming::INFINITE,
        Windows::Win32::System::ApplicationInstallationAndServicing::NTDDI_WIN7,
    );

    let path = PathBuf::from(windows_reader::workspace_dir())
        .join("audio-device-windows-sys")
        .join("src")
        .join("bindings.rs");

    let mut file = fs::File::create(&path)?;
    file.write_all(
        "// This file was generated by the `windows` crate - do not edit by hand!\n\n".as_bytes(),
    )?;
    file.write_all(tokens.as_bytes())?;
    drop(file);

    let mut cmd = process::Command::new("rustfmt");
    cmd.arg(&path);
    cmd.output()?;
    Ok(())
}
